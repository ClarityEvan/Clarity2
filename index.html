<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Clarity — Your Financial Future</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{--cream:#F5F0E8;--dark:#1A1A1A;--gold:#C4A35A;--gold-light:#E8D5A3;--muted:#7A7470;--border:#E0D9CE;--card:#FEFCF8;--white:#fff;--red:#7A2E2E;--green:#2D6A4F;}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{background:var(--cream);font-family:'DM Sans',sans-serif;font-weight:300;color:var(--dark);}
.screen{display:none;height:100dvh;flex-direction:column;overflow:hidden;}
.screen.active{display:flex;}
#setup{overflow-y:auto;-webkit-overflow-scrolling:touch;padding:32px 28px 32px;background:var(--cream);}
.wordmark{font-family:'Cormorant Garamond',serif;font-size:36px;font-weight:300;letter-spacing:9px;text-transform:uppercase;margin-bottom:4px;}
.tagline{font-size:11px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:28px;}
.s-title{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:400;margin-bottom:10px;}
.s-body{font-size:14px;line-height:1.82;color:var(--muted);margin-bottom:24px;}
.go-btn{display:block;width:100%;padding:18px;margin-top:8px;background:var(--dark);color:var(--cream);border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:12px;letter-spacing:3px;text-transform:uppercase;cursor:pointer;-webkit-appearance:none;transition:opacity 0.15s;}
.go-btn:active{opacity:0.8;}
.divider{border:none;border-top:1px solid var(--border);margin:24px 0;}
.what-lbl{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:18px;}
.steps{display:flex;flex-direction:column;gap:14px;}
.step{display:flex;gap:14px;}
.sn{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--gold);min-width:20px;line-height:1.1;}
.st{font-size:13px;line-height:1.78;color:var(--muted);}
.st b{color:var(--dark);font-weight:500;}
#chat{background:var(--card);}
.chat-hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;padding-top:max(14px,env(safe-area-inset-top));border-bottom:1px solid var(--border);background:var(--card);flex-shrink:0;}
.chat-logo{font-family:'Cormorant Garamond',serif;font-size:20px;letter-spacing:5px;text-transform:uppercase;}
.phase-pill{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);background:rgba(196,163,90,0.1);padding:4px 10px;border-radius:20px;border:1px solid var(--gold-light);}
.msgs{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:22px 18px 10px;display:flex;flex-direction:column;gap:16px;}
.msg{display:flex;flex-direction:column;gap:4px;animation:up 0.35s ease forwards;opacity:0;}
@keyframes up{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.ai{align-items:flex-start;}.msg.usr{align-items:flex-end;}
.msg-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);padding:0 3px;}
.bubble{max-width:90%;padding:13px 16px;border-radius:8px;line-height:1.78;font-size:15px;}
.msg.ai .bubble{background:var(--white);border:1px solid var(--border);}
.msg.usr .bubble{background:var(--dark);color:var(--cream);}
.speak-btn{background:none;border:none;font-size:18px;cursor:pointer;padding:2px 6px;opacity:0.6;align-self:flex-start;}
.typing-wrap{display:flex;flex-direction:column;gap:4px;align-items:flex-start;animation:up 0.3s ease forwards;opacity:0;}
.typing{display:flex;gap:5px;padding:14px 16px;background:var(--white);border:1px solid var(--border);border-radius:8px;}
.dot{width:7px;height:7px;background:var(--gold-light);border-radius:50%;animation:bounce 1.3s infinite;}
.dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-7px);background:var(--gold)}}
.input-bar{padding:10px 14px;padding-bottom:max(16px,env(safe-area-inset-bottom));border-top:1px solid var(--border);background:var(--white);flex-shrink:0;}
.input-row{display:flex;gap:9px;align-items:flex-end;}
.mic-btn{width:48px;height:48px;flex-shrink:0;border-radius:50%;border:2px solid var(--dark);background:var(--white);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;-webkit-appearance:none;}
.mic-btn.on{background:var(--dark);animation:mp 1.8s infinite;}
.mic-btn.on .mic-svg{stroke:var(--gold);}
@keyframes mp{0%,100%{box-shadow:0 0 0 0 rgba(196,163,90,0.4)}50%{box-shadow:0 0 0 12px rgba(196,163,90,0)}}
.mic-svg{width:20px;height:20px;stroke:var(--dark);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;transition:stroke 0.2s;}
.txt-input{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:22px;background:var(--cream);font-family:'DM Sans',sans-serif;font-size:16px;color:var(--dark);outline:none;-webkit-appearance:none;resize:none;max-height:100px;line-height:1.4;}
.txt-input:focus{border-color:var(--gold);}
.send-btn{width:48px;height:48px;flex-shrink:0;border-radius:50%;background:var(--gold);border:none;color:white;font-size:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-appearance:none;transition:opacity 0.15s;}
.send-btn:active{opacity:0.8;}
.send-btn:disabled{background:var(--border);}
.voice-hint{font-size:11px;color:var(--muted);margin-top:8px;text-align:center;}
#report{overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--cream);}
.rep-hdr{padding:14px 18px;padding-top:max(14px,env(safe-area-inset-top));border-bottom:1px solid var(--border);background:var(--card);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.rep-logo{font-family:'Cormorant Garamond',serif;font-size:18px;letter-spacing:4px;text-transform:uppercase;}
.back-btn{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);background:none;border:1px solid var(--border);padding:6px 12px;border-radius:4px;cursor:pointer;}
.rep-body{padding:28px 20px 60px;}
.rep-section{margin-bottom:36px;}
.rep-section-lbl{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:4px;}
.metric{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:16px;}
.metric-lbl{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.metric-val{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:300;line-height:1;}
.metric-note{font-size:11px;color:var(--muted);margin-top:4px;line-height:1.4;}
.metric.hi .metric-val{color:var(--gold);}
.metric.good .metric-val{color:var(--green);}
.metric.warn .metric-val{color:var(--red);}
.rep-text{font-size:14px;line-height:1.85;color:var(--dark);}
.rep-text p{margin-bottom:14px;}
.rep-items{display:flex;flex-direction:column;gap:10px;}
.rep-item{display:flex;gap:14px;padding:15px;background:var(--card);border:1px solid var(--border);border-radius:6px;}
.rep-icon{font-size:20px;flex-shrink:0;}
.rep-item-title{font-size:14px;font-weight:500;color:var(--dark);margin-bottom:4px;}
.rep-item-desc{font-size:13px;color:var(--muted);line-height:1.6;}
.disclaimer{margin-top:28px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:6px;font-size:11px;color:var(--muted);line-height:1.7;}
</style>
</head>
<body>

<div id="setup" class="screen active">
  <div class="wordmark">Clarity</div>
  <div class="tagline">Your Financial Future</div>
  <div class="s-title">Welcome</div>
  <div class="s-body">Clarity is your personal AI financial advisor. It will ask you about your income, savings, retirement accounts, debts, and goals — then give you a clear, personalized picture of where you stand and what to do next.<br><br>The conversation takes about 15-20 minutes. You can speak your answers or type them. Everything is private and secure.</div>
  <button class="go-btn" onclick="launch()">Begin My Financial Review</button>
  <div class="divider"></div>
  <div class="what-lbl">What We Cover</div>
  <div class="steps">
    <div class="step"><div class="sn">o</div><div class="st"><b>Income and taxes</b> - salary, bonus, equity, filing status</div></div>
    <div class="step"><div class="sn">o</div><div class="st"><b>Retirement accounts</b> - 401k, IRA, Roth, employer match</div></div>
    <div class="step"><div class="sn">o</div><div class="st"><b>Assets and debt</b> - home, investments, savings, loans</div></div>
    <div class="step"><div class="sn">o</div><div class="st"><b>Protection and goals</b> - insurance, college, retirement timeline</div></div>
  </div>
</div>

<div id="chat" class="screen">
  <div class="chat-hdr">
    <div class="chat-logo">Clarity</div>
    <div class="phase-pill" id="phase-pill">Getting Started</div>
  </div>
  <div class="msgs" id="msgs"></div>
  <div class="input-bar">
    <div class="input-row">
      <button class="mic-btn" id="mic-btn" onclick="toggleMic()">
        <svg class="mic-svg" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="11" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="19" x2="12" y2="22"/><line x1="8" y1="22" x2="16" y2="22"/></svg>
      </button>
      <textarea class="txt-input" id="txt-input" placeholder="Speak or type..." rows="1" oninput="grow(this)" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send();}"></textarea>
      <button class="send-btn" id="send-btn" onclick="send()">&#8593;</button>
    </div>
    <div class="voice-hint" id="voice-hint">Tap the microphone to speak</div>
  </div>
</div>

<div id="report" class="screen">
  <div class="rep-hdr">
    <div class="rep-logo">Clarity</div>
    <button class="back-btn" onclick="show('chat')">Back</button>
  </div>
  <div class="rep-body" id="rep-body"></div>
</div>

<script>
var convHistory = [];
var profile = {};
var waiting = false;
var recog = null;
var listening = false;
var msgStore = {};

var SYSTEM = "You are Clarity, a warm and highly knowledgeable personal financial advisor AI. Conduct a comprehensive but conversational financial review. Speak like a trusted, brilliant friend.\n\nWork through these phases naturally, asking 1-2 questions at a time:\n\nPHASE 1 - ORIENTATION: Warm greeting. Ask one open question to learn age, marital status, employment, and general financial stage.\n\nPHASE 2 - INCOME AND TAXES: Total compensation, bonus, equity, spouse income. Filing status and state.\n\nPHASE 3 - RETIREMENT ACCOUNTS: 401k/403b and employer match, contribution level, Roth vs traditional, IRA, total retirement balance.\n\nPHASE 4 - ASSETS AND DEBT: Home value and mortgage, investment accounts, savings, emergency fund, major debts.\n\nPHASE 5 - PROTECTION AND DEPENDENTS: Life and disability insurance, kids and college savings.\n\nPHASE 6 - GOALS: Target retirement age, Social Security timing, major expenses, estate planning.\n\nAfter every response where you learn a financial fact, append on its own line: INSIGHT:{\"key\":\"value\"}\n\nKeys to use: age, maritalStatus, state, annualIncome, spouseIncome, totalHousehold, retirementBalance, homeValue, mortgageBalance, savingsBalance, totalDebt, retirementSavingsRate, retirementAge, yearsToRetirement, emergencyFundMonths, phase\n\nWhen you have enough info, say you are generating the report then output on its own line: REPORT:{\"assessment\":\"3 honest paragraphs\",\"projection\":\"2 paragraph retirement outlook\",\"opportunities\":[{\"icon\":\"emoji\",\"title\":\"...\",\"desc\":\"...\"}],\"gaps\":[{\"icon\":\"emoji\",\"title\":\"...\",\"desc\":\"...\"}]}\n\nTONE: Warm, direct, specific. Flag issues gently. Keep responses focused. Never use markdown headers (no # symbols). Use plain conversational text only.";

function launch() {
  show('chat');
  initSpeech();
  convHistory.push({ role:'user', content:'Hello, I would like a comprehensive review of my financial situation and a personalized report.' });
  showTyping();
  callAPI(convHistory).then(function(r) {
    hideTyping();
    if (r) handle(r);
  });
}

function show(id) {
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
}

function send() {
  var el = document.getElementById('txt-input');
  var txt = el.value.trim();
  if (!txt || waiting) return;
  el.value = '';
  el.style.height = '';
  addMsg('usr', txt);
  convHistory.push({ role:'user', content:txt });
  waiting = true;
  document.getElementById('send-btn').disabled = true;
  showTyping();
  callAPI(convHistory).then(function(r) {
    hideTyping();
    waiting = false;
    document.getElementById('send-btn').disabled = false;
    if (r) handle(r);
  });
}

function callAPI(msgs) {
  return fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ messages: msgs, system: SYSTEM })
  }).then(function(res) {
    if (!res.ok) {
      return res.json().then(function(e) {
        addMsg('ai', 'Error: ' + (e.error || 'Something went wrong.'));
        return null;
      });
    }
    return res.json().then(function(d) {
      if (d.audioBase64) playAudio(d.audioBase64);
      return d.text || null;
    });
  }).catch(function(e) {
    addMsg('ai', 'Connection error: ' + e.message);
    return null;
  });
}

function playAudio(base64) {
  try {
    var binary = atob(base64);
    var bytes = new Uint8Array(binary.length);
    for (var i = 0; i < binary.length; i++) { bytes[i] = binary.charCodeAt(i); }
    var blob = new Blob([bytes], { type: 'audio/mpeg' });
    var url = URL.createObjectURL(blob);
    var audio = new Audio(url);
    audio.play().catch(function() {});
  } catch(e) {}
}

function handle(raw) {
  var lines = raw.split('\n');
  var insightLine = '';
  var cleanLines = [];
  var reportStr = '';
  var inReport = false;

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    if (line.indexOf('INSIGHT:') === 0) {
      insightLine = line.substring(8);
    } else if (line.indexOf('REPORT:') === 0) {
      reportStr = line.substring(7);
      inReport = true;
    } else if (inReport) {
      reportStr += '\n' + line;
    } else {
      cleanLines.push(line);
    }
  }

  if (insightLine) {
    try { Object.assign(profile, JSON.parse(insightLine)); } catch(e) {}
  }

  var reportData = null;
  if (reportStr) {
    try { reportData = JSON.parse(reportStr); } catch(e) {}
  }

  var text = cleanLines.join('\n').trim();
  if (text) {
    addMsg('ai', text);
    convHistory.push({ role:'assistant', content:text });
  }

  if (profile.phase) {
    document.getElementById('phase-pill').textContent = profile.phase;
  }

  if (reportData) {
    setTimeout(function() { buildReport(reportData); }, 1500);
  }
}

function addMsg(role, text) {
  var area = document.getElementById('msgs');
  var m = document.createElement('div');
  m.className = 'msg ' + role;
  var id = 'msg' + Date.now();
  var bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = fmt(text);
  var lbl = document.createElement('div');
  lbl.className = 'msg-lbl';
  lbl.textContent = role === 'ai' ? 'Clarity' : 'You';
  m.appendChild(lbl);
  m.appendChild(bubble);
  if (role === 'ai') {
    msgStore[id] = text;
    var btn = document.createElement('button');
    btn.className = 'speak-btn';
    btn.textContent = '\uD83D\uDD0A';
    btn.setAttribute('data-id', id);
    btn.onclick = function() { speakStored(this.getAttribute('data-id')); };
    m.appendChild(btn);
  }
  area.appendChild(m);
  setTimeout(function() { area.scrollTop = area.scrollHeight; }, 50);
}

function speakStored(id) {
  var text = msgStore[id];
  if (!text) return;
  var clean = text.replace(/\*\*/g, '');
  if (window.speechSynthesis) {
    window.speechSynthesis.cancel();
    var u = new SpeechSynthesisUtterance(clean);
    u.rate = 0.92;
    window.speechSynthesis.speak(u);
  }
}

function fmt(t) {
  return t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
}

function showTyping() {
  var area = document.getElementById('msgs');
  var t = document.createElement('div');
  t.className = 'typing-wrap';
  t.id = 'typing';
  t.innerHTML = '<div class="msg-lbl">Clarity</div><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
  area.appendChild(t);
  setTimeout(function() { area.scrollTop = area.scrollHeight; }, 50);
}

function hideTyping() {
  var t = document.getElementById('typing');
  if (t) t.remove();
}

function grow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function initSpeech() {
  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('voice-hint').textContent = 'Type your answers below';
    document.getElementById('mic-btn').style.opacity = '0.35';
    return;
  }
  recog = new SR();
  recog.continuous = false;
  recog.interimResults = true;
  recog.lang = 'en-US';
  recog.onstart = function() {
    listening = true;
    document.getElementById('mic-btn').classList.add('on');
    document.getElementById('voice-hint').textContent = 'Listening... speak now';
  };
  recog.onresult = function(e) {
    var t = Array.from(e.results).map(function(r) { return r[0].transcript; }).join('');
    document.getElementById('txt-input').value = t;
  };
  recog.onend = function() {
    listening = false;
    document.getElementById('mic-btn').classList.remove('on');
    document.getElementById('voice-hint').textContent = 'Tap the microphone to speak';
    var v = document.getElementById('txt-input').value.trim();
    if (v) send();
  };
  recog.onerror = function() {
    listening = false;
    document.getElementById('mic-btn').classList.remove('on');
  };
}

function toggleMic() {
  if (!recog) return;
  if (listening) recog.stop();
  else { document.getElementById('txt-input').value = ''; recog.start(); }
}

function buildReport(data) {
  var fmtD = function(v) {
    if (!v) return '-';
    var n = parseFloat(String(v).replace(/[^0-9.]/g, ''));
    if (isNaN(n)) return String(v);
    if (n >= 1000000) return '$' + (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return '$' + Math.round(n / 1000) + 'K';
    return '$' + n.toLocaleString();
  };
  var toN = function(v) { return parseFloat(String(v || 0).replace(/[^0-9.]/g, '')) || 0; };
  var p = profile;
  var nw = toN(p.retirementBalance) + toN(p.homeValue) + toN(p.savingsBalance) - toN(p.mortgageBalance) - toN(p.totalDebt);

  var html = '<div class="rep-section"><div class="rep-section-lbl">Financial Snapshot</div><div class="metrics-grid">'
    + '<div class="metric hi"><div class="metric-lbl">Household Income</div><div class="metric-val">' + fmtD(p.totalHousehold || p.annualIncome) + '</div><div class="metric-note">' + (p.state || 'Annual') + '</div></div>'
    + '<div class="metric hi"><div class="metric-lbl">Retirement Savings</div><div class="metric-val">' + fmtD(p.retirementBalance) + '</div><div class="metric-note">' + (p.retirementSavingsRate ? 'Saving ' + p.retirementSavingsRate + '%' : 'All accounts') + '</div></div>'
    + '<div class="metric good"><div class="metric-lbl">Est. Net Worth</div><div class="metric-val">' + (nw > 0 ? fmtD(nw) : '-') + '</div><div class="metric-note">Assets minus debts</div></div>'
    + '<div class="metric"><div class="metric-lbl">Years to Retire</div><div class="metric-val">' + (p.yearsToRetirement || '-') + '</div><div class="metric-note">' + (p.retirementAge ? 'Target age ' + p.retirementAge : '') + '</div></div>'
    + '<div class="metric ' + (toN(p.totalDebt) > 20000 ? 'warn' : 'good') + '"><div class="metric-lbl">Non-Mortgage Debt</div><div class="metric-val">' + (fmtD(p.totalDebt) || '$0') + '</div><div class="metric-note">Loans, cards, other</div></div>'
    + '<div class="metric"><div class="metric-lbl">Liquid Savings</div><div class="metric-val">' + fmtD(p.savingsBalance) + '</div><div class="metric-note">' + (p.emergencyFundMonths ? p.emergencyFundMonths + ' months' : '') + '</div></div>'
    + '</div></div>';

  if (data.assessment) html += '<div class="rep-section"><div class="rep-section-lbl">Overall Assessment</div><div class="rep-text"><p>' + data.assessment.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p></div></div>';
  if (data.projection) html += '<div class="rep-section"><div class="rep-section-lbl">Retirement Projection</div><div class="rep-text"><p>' + data.projection.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p></div></div>';

  if (data.opportunities && data.opportunities.length) {
    html += '<div class="rep-section"><div class="rep-section-lbl">Your Top Opportunities</div><div class="rep-items">';
    for (var i = 0; i < data.opportunities.length; i++) {
      var o = data.opportunities[i];
      html += '<div class="rep-item"><div class="rep-icon">' + (o.icon || '') + '</div><div><div class="rep-item-title">' + o.title + '</div><div class="rep-item-desc">' + o.desc + '</div></div></div>';
    }
    html += '</div></div>';
  }
  if (data.gaps && data.gaps.length) {
    html += '<div class="rep-section"><div class="rep-section-lbl">Risk Gaps to Address</div><div class="rep-items">';
    for (var j = 0; j < data.gaps.length; j++) {
      var g = data.gaps[j];
      html += '<div class="rep-item"><div class="rep-icon">' + (g.icon || '') + '</div><div><div class="rep-item-title">' + g.title + '</div><div class="rep-item-desc">' + g.desc + '</div></div></div>';
    }
    html += '</div></div>';
  }

  html += '<div class="disclaimer"><b>Disclaimer</b> - This report is generated by AI for informational purposes only. It does not constitute financial, legal, or tax advice. Please consult a licensed financial advisor before making significant financial decisions.</div>';
  document.getElementById('rep-body').innerHTML = html;
  show('report');
}
</script>
</body>
</html>
