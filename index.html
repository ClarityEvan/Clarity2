<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Clarity ‚Äî Your Financial Future</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#F5F0E8; --dark:#1A1A1A; --gold:#C4A35A;
  --gold-light:#E8D5A3; --muted:#7A7470; --border:#E0D9CE;
  --card:#FEFCF8; --white:#fff; --red:#7A2E2E; --green:#2D6A4F;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;}
body{background:var(--cream);font-family:'DM Sans',sans-serif;font-weight:300;color:var(--dark);}

.screen{display:none;height:100dvh;flex-direction:column;overflow:hidden;}
.screen.active{display:flex;}

/* ‚ïê‚ïê SETUP ‚ïê‚ïê */
#setup{overflow-y:auto;-webkit-overflow-scrolling:touch;padding:56px 28px 48px;background:var(--cream);}
.wordmark{font-family:'Cormorant Garamond',serif;font-size:42px;font-weight:300;letter-spacing:9px;text-transform:uppercase;margin-bottom:5px;}
.tagline{font-size:11px;letter-spacing:3px;color:var(--gold);text-transform:uppercase;margin-bottom:48px;}
.s-title{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:400;margin-bottom:10px;}
.s-body{font-size:14px;line-height:1.82;color:var(--muted);margin-bottom:24px;}
.go-btn{
  display:block;width:100%;padding:18px;margin-top:8px;
  background:var(--dark);color:var(--cream);border:none;border-radius:8px;
  font-family:'DM Sans',sans-serif;font-size:12px;letter-spacing:3px;
  text-transform:uppercase;cursor:pointer;-webkit-appearance:none;transition:opacity 0.15s;
}
.go-btn:active{opacity:0.8;}
.divider{border:none;border-top:1px solid var(--border);margin:36px 0;}
.what-lbl{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:18px;}
.steps{display:flex;flex-direction:column;gap:14px;}
.step{display:flex;gap:14px;}
.sn{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--gold);min-width:20px;line-height:1.1;}
.st{font-size:13px;line-height:1.78;color:var(--muted);}
.st b{color:var(--dark);font-weight:500;}

/* ‚ïê‚ïê CHAT ‚ïê‚ïê */
#chat{background:var(--card);}
.chat-hdr{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 18px;padding-top:max(14px,env(safe-area-inset-top));
  border-bottom:1px solid var(--border);background:var(--card);flex-shrink:0;
}
.chat-logo{font-family:'Cormorant Garamond',serif;font-size:20px;letter-spacing:5px;text-transform:uppercase;}
.phase-pill{
  font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--gold);
  background:rgba(196,163,90,0.1);padding:4px 10px;border-radius:20px;border:1px solid var(--gold-light);
}
.msgs{
  flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;
  padding:22px 18px 10px;display:flex;flex-direction:column;gap:16px;
}
.msg{display:flex;flex-direction:column;gap:4px;animation:up 0.35s ease forwards;opacity:0;}
@keyframes up{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.ai{align-items:flex-start;}.msg.usr{align-items:flex-end;}
.msg-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);padding:0 3px;}
.bubble{max-width:90%;padding:13px 16px;border-radius:8px;line-height:1.78;font-size:15px;}
.msg.ai .bubble{background:var(--white);border:1px solid var(--border);}
.msg.usr .bubble{background:var(--dark);color:var(--cream);}
.typing-wrap{display:flex;flex-direction:column;gap:4px;align-items:flex-start;animation:up 0.3s ease forwards;opacity:0;}
.typing{display:flex;gap:5px;padding:14px 16px;background:var(--white);border:1px solid var(--border);border-radius:8px;}
.dot{width:7px;height:7px;background:var(--gold-light);border-radius:50%;animation:bounce 1.3s infinite;}
.dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-7px);background:var(--gold)}}

/* INPUT */
.input-bar{
  padding:10px 14px;padding-bottom:max(16px,env(safe-area-inset-bottom));
  border-top:1px solid var(--border);background:var(--white);flex-shrink:0;
}
.input-row{display:flex;gap:9px;align-items:flex-end;}
.mic-btn{
  width:48px;height:48px;flex-shrink:0;border-radius:50%;
  border:2px solid var(--dark);background:var(--white);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all 0.2s;-webkit-appearance:none;
}
.mic-btn.on{background:var(--dark);animation:mp 1.8s infinite;}
.mic-btn.on .mic-svg{stroke:var(--gold);}
@keyframes mp{0%,100%{box-shadow:0 0 0 0 rgba(196,163,90,0.4)}50%{box-shadow:0 0 0 12px rgba(196,163,90,0)}}
.mic-svg{width:20px;height:20px;stroke:var(--dark);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;transition:stroke 0.2s;}
.txt-input{
  flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:22px;
  background:var(--cream);font-family:'DM Sans',sans-serif;font-size:16px;
  color:var(--dark);outline:none;-webkit-appearance:none;resize:none;
  max-height:100px;line-height:1.4;
}
.txt-input:focus{border-color:var(--gold);}
.send-btn{
  width:48px;height:48px;flex-shrink:0;border-radius:50%;
  background:var(--gold);border:none;color:white;font-size:20px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;-webkit-appearance:none;transition:opacity 0.15s;
}
.send-btn:active{opacity:0.8;}
.send-btn:disabled{background:var(--border);}
.voice-hint{font-size:11px;color:var(--muted);margin-top:8px;text-align:center;}

/* ‚ïê‚ïê REPORT ‚ïê‚ïê */
#report{overflow-y:auto;-webkit-overflow-scrolling:touch;background:var(--cream);}
.rep-hdr{
  padding:14px 18px;padding-top:max(14px,env(safe-area-inset-top));
  border-bottom:1px solid var(--border);background:var(--card);
  display:flex;justify-content:space-between;align-items:center;flex-shrink:0;
}
.rep-logo{font-family:'Cormorant Garamond',serif;font-size:18px;letter-spacing:4px;text-transform:uppercase;}
.back-btn{font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);background:none;border:1px solid var(--border);padding:6px 12px;border-radius:4px;cursor:pointer;}
.rep-body{padding:28px 20px 60px;}
.rep-section{margin-bottom:36px;}
.rep-section-lbl{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:4px;}
.metric{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:16px;}
.metric-lbl{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.metric-val{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:300;line-height:1;}
.metric-note{font-size:11px;color:var(--muted);margin-top:4px;line-height:1.4;}
.metric.hi .metric-val{color:var(--gold);}
.metric.good .metric-val{color:var(--green);}
.metric.warn .metric-val{color:var(--red);}
.rep-text{font-size:14px;line-height:1.85;color:var(--dark);}
.rep-text p{margin-bottom:14px;}
.rep-items{display:flex;flex-direction:column;gap:10px;}
.rep-item{display:flex;gap:14px;padding:15px;background:var(--card);border:1px solid var(--border);border-radius:6px;}
.rep-icon{font-size:20px;flex-shrink:0;}
.rep-item-title{font-size:14px;font-weight:500;color:var(--dark);margin-bottom:4px;}
.rep-item-desc{font-size:13px;color:var(--muted);line-height:1.6;}
.disclaimer{margin-top:28px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:6px;font-size:11px;color:var(--muted);line-height:1.7;}
</style>
</head>
<body>

<!-- SETUP -->
<div id="setup" class="screen active">
  <div class="wordmark">Clarity</div>
  <div class="tagline">Your Financial Future</div>
  <div class="s-title">Welcome</div>
  <div class="s-body">
    Clarity is your personal AI financial advisor. It will ask you about your income, savings, retirement accounts, debts, and goals ‚Äî then give you a clear, personalized picture of where you stand and what to do next.<br><br>
    The conversation takes about 15‚Äì20 minutes. You can speak your answers or type them. Everything is private and secure.
  </div>
  <button class="go-btn" onclick="launch()">Begin My Financial Review</button>
  <div class="divider"></div>
  <div class="what-lbl">What We Cover</div>
  <div class="steps">
    <div class="step"><div class="sn">‚ó¶</div><div class="st"><b>Income & taxes</b> ‚Äî salary, bonus, equity, filing status</div></div>
    <div class="step"><div class="sn">‚ó¶</div><div class="st"><b>Retirement accounts</b> ‚Äî 401k, IRA, Roth, employer match</div></div>
    <div class="step"><div class="sn">‚ó¶</div><div class="st"><b>Assets & debt</b> ‚Äî home, investments, savings, loans</div></div>
    <div class="step"><div class="sn">‚ó¶</div><div class="st"><b>Protection & goals</b> ‚Äî insurance, college, retirement timeline</div></div>
  </div>
</div>

<!-- CHAT -->
<div id="chat" class="screen">
  <div class="chat-hdr">
    <div class="chat-logo">Clarity</div>
    <div class="phase-pill" id="phase-pill">Getting Started</div>
  </div>
  <div class="msgs" id="msgs"></div>
  <div class="input-bar">
    <div class="input-row">
      <button class="mic-btn" id="mic-btn" onclick="toggleMic()">
        <svg class="mic-svg" viewBox="0 0 24 24">
          <rect x="9" y="2" width="6" height="11" rx="3"/>
          <path d="M5 10a7 7 0 0 0 14 0"/>
          <line x1="12" y1="19" x2="12" y2="22"/>
          <line x1="8" y1="22" x2="16" y2="22"/>
        </svg>
      </button>
      <textarea class="txt-input" id="txt-input" placeholder="Speak or type‚Ä¶" rows="1"
        oninput="grow(this)"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send();}"></textarea>
      <button class="send-btn" id="send-btn" onclick="send()">‚Üë</button>
    </div>
    <div class="voice-hint" id="voice-hint">Tap the microphone to speak</div>
  </div>
</div>

<!-- REPORT -->
<div id="report" class="screen">
  <div class="rep-hdr">
    <div class="rep-logo">Clarity</div>
    <button class="back-btn" onclick="show('chat')">‚Üê Back</button>
  </div>
  <div class="rep-body" id="rep-body"></div>
</div>

<script>
let history = [], profile = {}, waiting = false, recog = null, listening = false;

const SYSTEM = `You are Clarity, a warm and highly knowledgeable personal financial advisor AI. Conduct a comprehensive but conversational financial review. Speak like a trusted, brilliant friend ‚Äî never like a form or a robot.

Work through these phases naturally, asking 1-2 questions at a time, adapting based on answers:

PHASE 1 - ORIENTATION: Warm greeting. Ask one open question to learn age, marital status, employment, and general financial stage all at once.

PHASE 2 - INCOME & TAXES: Total compensation, bonus, equity, spouse income. Filing status and state.

PHASE 3 - RETIREMENT ACCOUNTS: 401k/403b and employer match, contribution level, Roth vs traditional, IRA situation, total retirement balance.

PHASE 4 - ASSETS & DEBT: Home value and mortgage, investment accounts, savings, emergency fund, major debts.

PHASE 5 - PROTECTION & DEPENDENTS: Life and disability insurance, kids and college savings, aging parents.

PHASE 6 - GOALS: Target retirement age and lifestyle, Social Security timing, major expenses coming up, estate planning.

INSIGHT EXTRACTION: After every response where you learn a financial fact, append on its own line:
INSIGHT:{"key":"value"}

Keys: age, maritalStatus, state, annualIncome, spouseIncome, totalHousehold, retirementBalance, homeValue, mortgageBalance, savingsBalance, totalDebt, retirementSavingsRate, retirementAge, yearsToRetirement, emergencyFundMonths, phase

REPORT: When you have enough info, say you are generating the report then output on its own line:
REPORT:{"assessment":"3 honest paragraphs","projection":"2 paragraph retirement outlook","opportunities":[{"icon":"üí°","title":"...","desc":"..."}],"gaps":[{"icon":"‚ö†Ô∏è","title":"...","desc":"..."}]}

TONE: Warm, direct, specific. Flag issues gently. Acknowledge when things look good. Keep responses focused.`;

function launch() {
  show('chat');
  initSpeech();
  begin();
}

function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

async function begin() {
  history.push({ role:'user', content:'Hello, I would like a comprehensive review of my financial situation and a personalized report.' });
  showTyping();
  const r = await ask(history);
  hideTyping();
  if (r) handle(r);
}

async function send() {
  const el = document.getElementById('txt-input');
  const txt = el.value.trim();
  if (!txt || waiting) return;
  el.value = ''; el.style.height = '';
  addMsg('usr', txt);
  history.push({ role:'user', content:txt });
  waiting = true;
  document.getElementById('send-btn').disabled = true;
  showTyping();
  const r = await ask(history);
  hideTyping();
  waiting = false;
  document.getElementById('send-btn').disabled = false;
  if (r) handle(r);
}

async function ask(msgs) {
  try {
    const res = await fetch('/api/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ messages: msgs, system: SYSTEM })
    });
    if (!res.ok) {
      const e = await res.json();
      addMsg('ai', '‚ö†Ô∏è Error: ' + (e.error || 'Something went wrong. Please try again.'));
      return null;
    }
    const d = await res.json();
    return d.text || null;
  } catch(e) {
    addMsg('ai', '‚ö†Ô∏è Connection error: ' + e.message);
    return null;
  }
}

function handle(raw) {
  const im = raw.match(/INSIGHT:(\{[^}\n]+\})/);
  if (im) { try { Object.assign(profile, JSON.parse(im[1])); } catch(e){} }

  const rm = raw.match(/REPORT:(\{[\s\S]+\})$/m);
  let reportData = null;
  if (rm) { try { reportData = JSON.parse(rm[1]); } catch(e){} }

  let text = raw.replace(/INSIGHT:\{[^}\n]+\}/g,'').replace(/REPORT:\{[\s\S]+\}$/m,'').trim();
  if (text) {
    addMsg('ai', text);
    history.push({ role:'assistant', content:text });
    speak(text);
  }

  if (profile.phase) document.getElementById('phase-pill').textContent = profile.phase;
  if (reportData) setTimeout(() => buildReport(reportData), 1500);
}

function addMsg(role, text) {
  const area = document.getElementById('msgs');
  const m = document.createElement('div');
  m.className = 'msg ' + role;
  m.innerHTML = `<div class="msg-lbl">${role==='ai'?'Clarity':'You'}</div><div class="bubble">${fmt(text)}</div>`;
  area.appendChild(m);
  setTimeout(() => area.scrollTop = area.scrollHeight, 50);
}

function fmt(t) {
  return t.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>');
}

function showTyping() {
  const area = document.getElementById('msgs');
  const t = document.createElement('div');
  t.className = 'typing-wrap'; t.id = 'typing';
  t.innerHTML = `<div class="msg-lbl">Clarity</div><div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
  area.appendChild(t);
  setTimeout(() => area.scrollTop = area.scrollHeight, 50);
}
function hideTyping() { const t = document.getElementById('typing'); if(t) t.remove(); }
function grow(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,100)+'px'; }

function initSpeech() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('voice-hint').textContent = 'Type your answers below';
    document.getElementById('mic-btn').style.opacity = '0.35';
    return;
  }
  recog = new SR();
  recog.continuous = false; recog.interimResults = true; recog.lang = 'en-US';
  recog.onstart = () => { listening=true; document.getElementById('mic-btn').classList.add('on'); document.getElementById('voice-hint').textContent='Listening‚Ä¶ speak now'; };
  recog.onresult = (e) => { document.getElementById('txt-input').value = Array.from(e.results).map(r=>r[0].transcript).join(''); };
  recog.onend = () => { listening=false; document.getElementById('mic-btn').classList.remove('on'); document.getElementById('voice-hint').textContent='Tap the microphone to speak'; const v=document.getElementById('txt-input').value.trim(); if(v) send(); };
  recog.onerror = () => { listening=false; document.getElementById('mic-btn').classList.remove('on'); };
}

function toggleMic() {
  if (!recog) return;
  if (listening) recog.stop(); else { document.getElementById('txt-input').value=''; recog.start(); }
}

function speak(text) {
  if (!window.speechSynthesis) return;
  const clean = text.replace(/\*\*/g,'').replace(/INSIGHT:[^\n]*/g,'').trim();
  if (clean.length > 300) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(clean);
  u.rate = 0.95;
  window.speechSynthesis.speak(u);
}

function buildReport(data) {
  const fmt$ = v => { if(!v) return '‚Äî'; const n=parseFloat(String(v).replace(/[^0-9.]/g,'')); if(isNaN(n)) return String(v); if(n>=1e6) return '$'+(n/1e6).toFixed(1)+'M'; if(n>=1000) return '$'+Math.round(n/1000)+'K'; return '$'+n.toLocaleString(); };
  const toN = v => parseFloat(String(v||0).replace(/[^0-9.]/g,''))||0;
  const p = profile;
  const nw = toN(p.retirementBalance)+toN(p.homeValue)+toN(p.savingsBalance)-toN(p.mortgageBalance)-toN(p.totalDebt);

  let html = `<div class="rep-section"><div class="rep-section-lbl">Financial Snapshot</div><div class="metrics-grid">
    <div class="metric hi"><div class="metric-lbl">Household Income</div><div class="metric-val">${fmt$(p.totalHousehold||p.annualIncome)}</div><div class="metric-note">${p.state||'Annual'}</div></div>
    <div class="metric hi"><div class="metric-lbl">Retirement Savings</div><div class="metric-val">${fmt$(p.retirementBalance)}</div><div class="metric-note">${p.retirementSavingsRate?'Saving '+p.retirementSavingsRate+'%':'All accounts'}</div></div>
    <div class="metric good"><div class="metric-lbl">Est. Net Worth</div><div class="metric-val">${nw>0?fmt$(nw):'‚Äî'}</div><div class="metric-note">Assets minus debts</div></div>
    <div class="metric"><div class="metric-lbl">Years to Retire</div><div class="metric-val">${p.yearsToRetirement||'‚Äî'}</div><div class="metric-note">${p.retirementAge?'Target age '+p.retirementAge:''}</div></div>
    <div class="metric ${toN(p.totalDebt)>20000?'warn':'good'}"><div class="metric-lbl">Non-Mortgage Debt</div><div class="metric-val">${fmt$(p.totalDebt)||'$0'}</div><div class="metric-note">Loans, cards, other</div></div>
    <div class="metric"><div class="metric-lbl">Liquid Savings</div><div class="metric-val">${fmt$(p.savingsBalance)}</div><div class="metric-note">${p.emergencyFundMonths?p.emergencyFundMonths+' months':''}</div></div>
  </div></div>`;

  if (data.assessment) html += `<div class="rep-section"><div class="rep-section-lbl">Overall Assessment</div><div class="rep-text"><p>${data.assessment.replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>')}</p></div></div>`;
  if (data.projection) html += `<div class="rep-section"><div class="rep-section-lbl">Retirement Projection</div><div class="rep-text"><p>${data.projection.replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>')}</p></div></div>`;

  if (data.opportunities?.length) {
    html += `<div class="rep-section"><div class="rep-section-lbl">Your Top Opportunities</div><div class="rep-items">`;
    data.opportunities.forEach(o => { html += `<div class="rep-item"><div class="rep-icon">${o.icon||'üí°'}</div><div><div class="rep-item-title">${o.title}</div><div class="rep-item-desc">${o.desc}</div></div></div>`; });
    html += `</div></div>`;
  }
  if (data.gaps?.length) {
    html += `<div class="rep-section"><div class="rep-section-lbl">Risk Gaps to Address</div><div class="rep-items">`;
    data.gaps.forEach(g => { html += `<div class="rep-item"><div class="rep-icon">${g.icon||'‚ö†Ô∏è'}</div><div><div class="rep-item-title">${g.title}</div><div class="rep-item-desc">${g.desc}</div></div></div>`; });
    html += `</div></div>`;
  }

  html += `<div class="disclaimer"><b>Disclaimer</b> ‚Äî This report is generated by AI for informational purposes only. It does not constitute financial, legal, or tax advice. Please consult a licensed financial advisor before making significant financial decisions.</div>`;
  document.getElementById('rep-body').innerHTML = html;
  show('report');
}
</script>
</body>
</html>
